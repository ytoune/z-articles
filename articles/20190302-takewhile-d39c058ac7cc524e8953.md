---
title: 'takeWhile ã¯ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ (ç„¡é§„ãªãƒ¡ãƒ¢ãƒªæ¶ˆè²») ã®åŸå› ã«ãªã‚Šå¾—ã‚‹'
emoji: 'ğŸ–ï¸'
type: 'tech'
topics: ['javascript', 'typescript', 'rxjs', 'react']
published: true
---

# `takeWhile` ã«å‚ç…§é€éã§ãªã„å¼ã‚’æ¸¡ã™ã®ã¯è‰¯ããªã„ã€‚

ä¸Šè¨˜ãŒåˆ†ã‹ã£ã¦ã„ã‚Œã°ä¸‹è¨˜ã‚’èª­ã‚€å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

# çµŒç·¯

[React é–‹ç™ºãƒã‚¦ãƒã‚¦ãƒ¡ãƒ¢ï¼ˆéšæ™‚æ›´æ–°ï¼‰](https://qiita.com/pikohideaki/items/690208a519c36a983d09)
ä¸Šè¨˜è¨˜äº‹ã‚’èª­ã‚“ã§ `unsubscribe` ã‚’ `componentWillUnmount` ã«æ›¸ã‹ãªã„æ–¹æ³•ã‚’çŸ¥ã£ãŸã®ã§èª¿ã¹ã¦ã¿ãŸã€‚[^1]

[^1]: `useEffect` ã®ã‚ã‚‹ä»Šã® `React` ã§ `componentWillUnmount` ã®ã‚ˆã†ãªå¤ã„æ–¹æ³•ã‚’ä½¿ã†å¿…è¦ã¯ãªã„ã¨æ€ã†ã€‚

# `takeWhile` ã¯ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®åŸå› ã«ãªã‚Šå¾—ã‚‹ã€‚

`takeWhile` ã¯å€¤ãŒæ¥ãŸã¨ãã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹ã®ã§å€¤ãŒæ¥ãªã‘ã‚Œã° `unsubscribe` ã•ã‚Œãªã„ã€‚
ç„¡é§„ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ã‚„ DB ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¶šã‘ã¦ã—ã¾ã†ã€‚
`takeWhile` ã¯å€¤ã«å¿œã˜ã¦å‡¦ç†ã‚’ç¶šã‘ã‚‹ã¹ãã‹æ±ºã¾ã‚‹å ´åˆã§ä½¿ã†ã¹ãã€‚

`Observable` ã‚’æµã‚Œã‚‹å€¤ã¨é–¢ä¿‚ãªãå‡¦ç†ã‚’æ­¢ã‚ãŸã„ãªã‚‰ `unsubscribe` ã‚’å‘¼ã¶ã‹ `takeUntil` ã‚’ä½¿ã†ã€‚

# ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã‚‹

å®Ÿéš›ã«è©¦ã—ã¦ã¿ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ãŸã€‚
ãã‚Œã‚‰ã§ä¸‹è¨˜ã® 3 ã¤ã®é–¢æ•°ã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚

```ts:utils.ts
// s ç§’å¾…ã¤
const sleep = (s: number) => new Promise(r => setTimeout(r, s * 1000))
// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã¤ã‘ã¦ãƒ­ã‚°ã‚’å‡ºã™
const log = (...v: any[]) => {
  const ts = (performance.now() / 1000) | 0
  console.log(...v, `(${ts})`)
}
// ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã‚‹ Observable ã‚’ç”Ÿæˆ
const make = (name: string) => {
  return new Observable<number>(s => {
    let canceled = false
    const push = (v: number) => {
      log(name, 'sub1', v, '- canceled', canceled)
      s.next(v)
    }
    Promise.resolve().then(async () => {
      push(12) // ã™ãã« 12 ã‚’æ¸¡ã™
      await sleep(10) // 10 ç§’å¾…ã£ã¦ã‹ã‚‰
      push(13) // 13 ã‚’æ¸¡ã™
      push(14) // 14 ã‚’æ¸¡ã™
    })
    return () => {
      log(name, 'unsub1')
      canceled = true
    }
  })
}
```

# ãƒ†ã‚¹ãƒˆå†…å®¹

ä¸Šè¨˜ `make` ã§ `Observable` ã‚’ç”Ÿæˆã—ãŸã®ã¡ 1 ç§’å¾Œã«å‡¦ç†ã‚’æ­¢ã‚ã‚‹ã€‚

# `unsubscribe` ã™ã‚‹

ä¸€èˆ¬çš„ãªã‚„ã‚Šã‹ãŸã§ã‚ã‚‹ã¨æ€ã‚ã‚Œã‚‹ã€‚
å•é¡Œãªãå‹•ã„ã¦ã„ã‚‹ã€‚

```ts:test1.ts
const test1 = async () => {
  const read = make('test1').pipe(
    tap(v => log('test1', 'sub2', v)),
  ).subscribe()
  await sleep(1)
  read.unsubscribe()
}
test1() /*
test1 sub1 12 - canceled false (0)
test1 sub2 12 (0)
test1 unsub1 (1)
test1 sub1 13 - canceled true (10)
test1 sub1 14 - canceled true (10)
*/
```

# `takeWhile` ã‚’ä½¿ã†

1 ç§’å¾Œã«æ­¢ã‚ã‚ˆã†ã¨ã—ãŸãŒã€ãã®å¾Œ 9 ç§’çµŒã£ã¦æ¬¡ã®å€¤ãŒæ¥ã‚‹ã¾ã§æ­¢ã¾ã£ã¦ã„ãªã„ã€‚

```ts:test2.ts
const test2 = async () => {
  let alive = true
  make('test2').pipe(
    takeWhile(() => alive),
    tap(v => log('test2', 'sub2', v)),
  ).subscribe()
  await sleep(1)
  alive = false
}
test2() /*
test2 sub1 12 - canceled false (0)
test2 sub2 12 (0)
test2 sub1 13 - canceled false (10)
test2 unsub1 (10)
test2 sub1 14 - canceled true (10)
*/
```

# `takeUntil` ã‚’ä½¿ã†

å•é¡Œãªãå‹•ãã€‚

```ts:test3.ts
const test3 = async () => {
  const unsub = new Subject<void>()
  make('test3').pipe(
    takeUntil(unsub),
    tap(v => log('test3', 'sub2', v)),
  ).subscribe()
  await sleep(1)
  unsub.next()
  unsub.complete()
}
test3() /*
test3 sub1 12 - canceled false (0)
test3 sub2 12 (0)
test3 unsub1 (1)
test3 sub1 13 - canceled true (10)
test3 sub1 14 - canceled true (10)
*/
```

# `unsubscribe` ã¨ `takeUntil` ã€ã©ã¡ã‚‰ã‚’ä½¿ã†ã¹ãã‹ï¼Ÿ

[ã“ã¡ã‚‰ã®è¨˜äº‹ (è‹±èª)](https://brianflove.com/2016/12/11/anguar-2-unsubscribe-observables/)ã§ã¯ `takeUntil` ãŒã‚ªã‚¹ã‚¹ãƒ¡ã•ã‚Œã¦ã„ã‚‹ã€‚

æ‰‹ç¶šãçš„ãª `unsubscribe` ã‚ˆã‚Šã‚‚å®£è¨€çš„ãª `takeUntil` ãŒè‰¯ã„ã¨ã„ã†åˆ¤æ–­ã ã‚ã†ã‹ï¼Ÿ

# è£œè¶³

### `React` ã¨ `RxJS` ã‚’çµ„ã¿åˆã‚ã›ã‚‹å ´åˆ

å¤§è¦æ¨¡ãªã‚¢ãƒ—ãƒªãªã‚‰ `redux-observable` ã‚’ã€å°è¦æ¨¡ãªã‚‰ `rxjs-hooks` ã‚’ä½¿ã†ã“ã¨ã‚’å‹§ã‚ã‚‹ã€‚
å¤ã„ `React` ã‚’ä½¿ã£ã¦ã„ã‚‹ãªã‚‰ `recompose` ã‚‚è‰¯ã„ã€‚
